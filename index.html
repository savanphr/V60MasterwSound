<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V60 Master Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/240/espresso-cup.png">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        button { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { font-family: sans-serif; min-height: 100vh; transition: 0.3s; -webkit-user-select: none; }
        
        body.light { background-color: #f5f5f4; color: #1c1917; }
        body.dark { background-color: #1c1917; color: #f5f5f4; }
        
        .card { transition: 0.3s; }
        .light .card { background-color: #ffffff; }
        .dark .card { background-color: #292524; }

        /* FIX CONTRASTE PARAMÈTRES */
        .settings-label { color: #57534e !important; font-weight: 800; }
        .dark .settings-label { color: #7b7876 !important; }

        .music-btn-style {
            background-color: #e7e5e4 !important;
            color: #1c1917 !important;
            border: 1px solid #d6d3d1 !important;
            transition: all 0.2s ease-in-out;
        }
        .dark .music-btn-style {
            background-color: #44403c !important;
            color: #ffffff !important;
            border: 1px solid #57534e !important;
        }

        .music-btn-style.music-loaded {
            color: #fbbf24 !important; 
            border-color: #fbbf24 !important;
            border-width: 2px !important;
            font-weight: 900 !important;
        }

        input {
            background-color: #f5f5f4 !important;
            color: #1c1917 !important;
            border: 2px solid #e7e5e4 !important;
        }
        .dark input {
            background-color: #1c1917 !important;
            color: #ffffff !important;
            border: 2px solid #44403c !important;
        }

        .btn-vibrant { background-color: #d97706 !important; color: #ffffff !important; }
        .btn-inactive { background-color: #44403c !important; color: #a8a29e !important; opacity: 0.3 !important; }
        .step-active { border-color: #fbbf24 !important; background-color: rgba(251, 191, 36, 0.1) !important; }

        /* ANIMATION VAPEUR */
        @keyframes steam {
            0% { transform: translateY(0) scaleX(1); opacity: 0; }
            15% { opacity: 0.6; }
            50% { transform: translateY(-10px) scaleX(1.2); opacity: 0.3; }
            100% { transform: translateY(-20px) scaleX(1.5); opacity: 0; }
        }
        .steam-path { opacity: 0; }
        .is-brewing .steam-path { animation: steam 2s infinite ease-out; }
        .steam-path:nth-child(2) { animation-delay: 0.4s; }
        .steam-path:nth-child(3) { animation-delay: 0.8s; }

        .hidden { display: none; }
    </style>
</head>
<body class="light">

    <div class="max-w-md mx-auto p-6 pb-24 text-center">
        <div class="flex justify-between items-center mb-6">
            <button onclick="openModal('guide-modal')" class="p-3 card rounded-full shadow-sm text-amber-600 active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
            </button>
            <h1 class="text-2xl font-black uppercase tracking-tighter">V60 Master</h1>
            <button onclick="openModal('settings-modal')" class="p-3 card rounded-full shadow-sm text-amber-600 active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"></circle><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path></svg>
            </button>
        </div>

        <div id="coffee-icon-container" class="flex justify-center mb-2">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path class="steam-path" d="M10 6C10 6 9 4.5 9 3.5C9 2.5 10 2 10 2" />
                <path class="steam-path" d="M14 6C14 6 13 4.5 13 3.5C13 2.5 14 2 14 2" />
                <path class="steam-path" d="M12 5C12 5 11 3.5 11 2.5C11 1.5 12 1 12 1" />
                <path d="M17 8H7C5.89543 8 5 8.89543 5 10V16C5 18.2091 6.79086 20 9 20H13C15.2091 20 17 18.2091 17 16V10C17 8.89543 16.1046 8 15 8" />
                <path d="M17 9H19C20.1046 9 21 9.89543 21 11V13C21 14.1046 20.1046 15 19 15H17" />
            </svg>
        </div>
        
        <div id="main-timer" class="text-7xl font-mono font-bold mb-10 text-amber-600">00:00</div>

        <div id="steps-container" class="space-y-4 text-left">
            <div id="step-1" class="card p-5 rounded-3xl border-2 border-transparent step-active">
                <div class="flex justify-between items-center mb-3"><h2 class="font-bold">1. Bloom</h2><span id="badge-1" class="text-xs opacity-50 font-bold">30s</span></div>
                <button id="btn-1" onclick="startPhase(1)" class="w-full btn-vibrant py-4 rounded-2xl font-black uppercase text-xs">Démarrer</button>
            </div>
            <div id="step-2" class="card p-5 rounded-3xl border-2 border-transparent opacity-40">
                <div class="flex justify-between items-center mb-3"><h2 class="font-bold">2. Versage 1</h2><span id="badge-2" class="text-xs opacity-50 font-bold">30s</span></div>
                <button id="btn-2" onclick="startPhase(2)" disabled class="w-full btn-inactive py-4 rounded-2xl font-black uppercase text-xs">Démarrer</button>
            </div>
            <div id="step-3" class="card p-5 rounded-3xl border-2 border-transparent opacity-40">
                <div class="flex justify-between items-center mb-3"><h2 class="font-bold">3. Versage 2</h2><span id="badge-3" class="text-xs opacity-50 font-bold">60s</span></div>
                <button id="btn-3" onclick="startPhase(3)" disabled class="w-full btn-inactive py-4 rounded-2xl font-black uppercase text-xs">Démarrer</button>
            </div>
            <div id="step-4" class="card p-5 rounded-3xl border-2 border-transparent opacity-40">
                <div class="flex justify-between items-center mb-3"><h2 class="font-bold">4. Écoulement</h2><span class="text-xs opacity-40 uppercase font-bold">Libre</span></div>
                <button id="btn-4" onclick="startPhase(4)" disabled class="w-full btn-inactive py-4 rounded-2xl font-black uppercase text-xs">Chrono Final</button>
            </div>
        </div>

        <button onclick="resetApp()" class="w-full mt-12 text-stone-500 text-xs tracking-[0.3em] uppercase font-black py-4 active:text-amber-600">Réinitialiser l'App</button>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6 text-left">
        <div class="card w-full max-w-xs rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h2 class="text-xl font-bold mb-6 dark:text-white">Réglages</h2>
            <div class="space-y-6">
                <div class="flex justify-between items-center bg-stone-100 dark:bg-stone-800 p-4 rounded-2xl">
                    <span class="text-xs font-black uppercase settings-label">Mode Sombre</span>
                    <button onclick="toggleTheme()" id="theme-toggle" class="w-12 h-6 bg-stone-400 rounded-full relative transition-all">
                        <div id="toggle-dot" class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-1 transition-all"></div>
                    </button>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between items-baseline px-1">
                        <p class="text-[10px] font-black uppercase text-amber-600">Musiques</p>
                        <button onclick="resetMusics()" class="text-[8px] font-bold uppercase text-stone-400 active:text-red-500">Vider tout ✕</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="triggerUpload(1)" id="music-btn-1" class="p-3 rounded-xl text-[9px] font-bold uppercase music-btn-style">Bloom ♫</button>
                        <button onclick="triggerUpload(2)" id="music-btn-2" class="p-3 rounded-xl text-[9px] font-bold uppercase music-btn-style">Versage 1 ♫</button>
                        <button onclick="triggerUpload(3)" id="music-btn-3" class="p-3 rounded-xl text-[9px] font-bold uppercase music-btn-style">Versage 2 ♫</button>
                        <button onclick="triggerUpload(4)" id="music-btn-4" class="p-3 rounded-xl text-[9px] font-bold uppercase music-btn-style">Final ♫</button>
                    </div>
                </div>
                <input type="file" id="music-input" class="hidden" accept="audio/*" onchange="handleFile(event)">
                <div class="space-y-4">
                    <div><label class="block text-[10px] font-bold uppercase mb-1 settings-label">Bloom (sec)</label><input type="number" id="input-dur-1" class="w-full p-4 rounded-2xl outline-none font-bold"></div>
                    <div><label class="block text-[10px] font-bold uppercase mb-1 settings-label">Versage 1 (sec)</label><input type="number" id="input-dur-2" class="w-full p-4 rounded-2xl outline-none font-bold"></div>
                    <div><label class="block text-[10px] font-bold uppercase mb-1 settings-label">Versage 2 (sec)</label><input type="number" id="input-dur-3" class="w-full p-4 rounded-2xl outline-none font-bold"></div>
                </div>
            </div>
            <button onclick="closeModal('settings-modal'); saveSettings();" class="w-full mt-8 py-4 rounded-2xl font-bold uppercase text-xs shadow-lg bg-[#d97706] text-white">Enregistrer</button>
        </div>
    </div>

	<div id="guide-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 text-left">
	  <div class="card w-full max-w-lg rounded-3xl p-6 shadow-2xl transition-colors">
	    <div class="flex justify-between items-center mb-4">
	      <h2 class="text-xl font-black uppercase tracking-tight">Guide V60</h2>
	      <button onclick="closeModal('guide-modal')" class="text-amber-600 font-bold">Fermer</button>
	    </div>
	    <div class="max-h-[70vh] overflow-y-auto pr-2 space-y-6 text-sm leading-relaxed">
	      <section>
	        <h3 class="font-bold text-amber-600 text-base mb-1">1. L'objectif</h3>
	        <p>Tirer le meilleur de son café en jouant sur ratio, mouture et technique de verse. La recette dépend du type de café et de ton goût final.</p>
	      </section>
	      <section>
	        <h3 class="font-bold text-amber-600 text-base mb-1">2. Ratio café / eau</h3>
	        <p>Démonstration : 19g café pour 300g eau (1:16).</p>
	        <ul class="list-disc ml-4 mt-2">
	          <li><strong>Light :</strong> 1:15 | <strong>Medium :</strong> 1:16 | <strong>Dark :</strong> 1:17+</li>
	        </ul>
	      </section>
	      <section>
	        <h3 class="font-bold text-amber-600 text-base mb-1">3. Mouture</h3>
	        <p>Light Roast : Medium-fine (sel de table). Dark Roast : Légèrement plus grossière.</p>
	      </section>
	      <section>
	        <h3 class="font-bold text-amber-600 text-base mb-1">4. Préparation</h3>
	        <p>Plier le filtre, le placer dans la V60 et rincer à l'eau chaude. Jeter l'eau de rinçage avant de commencer.</p>
	      </section>
	    </div>
	  </div>
	</div>
  
    <audio id="global-player"></audio>

    <script>
        let totalSeconds = 0, timerInterval = null, audioCtx = null, targetSecondsForPhase = 0;
        let durations = JSON.parse(localStorage.getItem('v60_durations')) || { 1: 30, 2: 30, 3: 60, 4: 999 };
        let currentTheme = localStorage.getItem('v60_theme') || 'light';
        let stepMusics = { 1: null, 2: null, 3: null, 4: null };
        let currentUploadStep = 1;

        (function init() {
            applyTheme(currentTheme);
            document.getElementById('input-dur-1').value = durations[1];
            document.getElementById('input-dur-2').value = durations[2];
            document.getElementById('input-dur-3').value = durations[3];
            updateBadges();
        })();

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function triggerUpload(step) { currentUploadStep = step; document.getElementById('music-input').click(); }
        function handleFile(e) {
            const file = e.target.files[0];
            if (file) {
                stepMusics[currentUploadStep] = URL.createObjectURL(file);
                document.getElementById(`music-btn-${currentUploadStep}`).classList.add('music-loaded'); 
            }
        }

        function resetMusics() {
            if(confirm("Vider toutes les musiques chargées ?")) {
                stepMusics = { 1: null, 2: null, 3: null, 4: null };
                document.querySelectorAll('.music-btn-style').forEach(btn => btn.classList.remove('music-loaded'));
            }
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('v60_theme', currentTheme);
            applyTheme(currentTheme);
        }

        function applyTheme(theme) {
            document.body.className = theme;
            const dot = document.getElementById('toggle-dot'), bg = document.getElementById('theme-toggle');
            if(dot) dot.style.left = theme === 'dark' ? '26px' : '4px';
            if(bg) bg.style.backgroundColor = theme === 'dark' ? '#d97706' : '#a8a29e';
        }

        function playNotification() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            function createBip(time) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.type = 'sine'; osc.frequency.setValueAtTime(1046.50, time);
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.5, time + 0.02); 
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
                osc.start(time); osc.stop(time + 0.2);
            }
            createBip(now); createBip(now + 0.25); 
        }

        function startPhase(id) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const player = document.getElementById('global-player');
            player.pause();
            if (stepMusics[id]) { player.src = stepMusics[id]; player.play().catch(e => {}); }

            // ACTIVER VAPEUR
            document.getElementById('coffee-icon-container').classList.add('is-brewing');

            document.querySelectorAll('[id^="step-"]').forEach(el => { 
                el.classList.add('opacity-40'); el.classList.remove('step-active'); 
            });
            const activeStep = document.getElementById('step-'+id);
            activeStep.classList.remove('opacity-40'); activeStep.classList.add('step-active');
            document.getElementById('btn-' + id).classList.add('hidden');

            targetSecondsForPhase = totalSeconds + durations[id];
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                totalSeconds++;
                const mins = Math.floor(totalSeconds / 60), secs = totalSeconds % 60;
                document.getElementById('main-timer').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                if (totalSeconds >= targetSecondsForPhase && id < 4) stopTimer(id);
            }, 1000);
        }

        function stopTimer(id) {
            clearInterval(timerInterval); timerInterval = null;
            document.getElementById('global-player').pause();
            
            // DÉSACTIVER VAPEUR
            document.getElementById('coffee-icon-container').classList.remove('is-brewing');

            playNotification();
            const nextBtn = document.getElementById('btn-' + (id + 1));
            if (nextBtn) {
                nextBtn.disabled = false;
                nextBtn.className = "w-full btn-vibrant py-4 rounded-2xl font-black uppercase text-xs";
            }
        }

        function saveSettings() {
            durations[1] = parseInt(document.getElementById('input-dur-1').value) || 30;
            durations[2] = parseInt(document.getElementById('input-dur-2').value) || 30;
            durations[3] = parseInt(document.getElementById('input-dur-3').value) || 60;
            localStorage.setItem('v60_durations', JSON.stringify(durations));
            updateBadges();
        }

        function updateBadges() {
            [1,2,3].forEach(i => {
                const b = document.getElementById(`badge-${i}`);
                if (b) b.textContent = durations[i] + 's';
            });
        }

        function resetApp() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null; totalSeconds = 0;
            document.getElementById('main-timer').textContent = "00:00";
            document.getElementById('global-player').pause();
            document.getElementById('coffee-icon-container').classList.remove('is-brewing');
            document.querySelectorAll('[id^="step-"]').forEach((el, i) => {
                el.classList.add('opacity-40'); el.classList.remove('step-active');
                if (i === 0) { el.classList.remove('opacity-40'); el.classList.add('step-active'); }
            });
            document.querySelectorAll('button[id^="btn-"]').forEach((btn, i) => {
                btn.classList.remove('hidden');
                if (i === 0) {
                    btn.disabled = false;
                    btn.className = "w-full btn-vibrant py-4 rounded-2xl font-black uppercase text-xs";
                } else {
                    btn.disabled = true;
                    btn.className = "w-full btn-inactive py-4 rounded-2xl font-black uppercase text-xs";
                }
            });
        }
    </script>
</body>
</html>